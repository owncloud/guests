---
kind: pipeline
name: matrix-1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: test-javascript
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-js

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

---
kind: pipeline
name: matrix-2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: ${DB_TYPE}
    db_name: ${DB_NAME}
    db_password: owncloud
    db_type: ${DB_TYPE}
    db_username: autotest
    version: daily-master-qa

- name: owncloud-coding-standard
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-codecheck
  - make test-php-style

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

---
kind: pipeline
name: matrix-3

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: ${DB_TYPE}
    db_name: ${DB_NAME}
    db_password: owncloud
    db_type: ${DB_TYPE}
    db_username: autotest
    version: daily-master-qa

- name: owncloud-coding-standard
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make test-php-codecheck
  - make test-php-style

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

---
kind: pipeline
name: matrix-4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ -z "true" ]; then make test-php-unit; fi
  - if [ "true" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: true

- name: codecov
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    paths:
    - tests/output
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

---
kind: pipeline
name: matrix-5

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ -z "true" ]; then make test-php-unit; fi
  - if [ "true" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: true

- name: codecov
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    paths:
    - tests/output
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

---
kind: pipeline
name: matrix-6

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: pgsql
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ -z "true" ]; then make test-php-unit; fi
  - if [ "true" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: true

- name: codecov
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    paths:
    - tests/output
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: pgsql
  pull: if-not-exists
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

---
kind: pipeline
name: matrix-7

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: oci
    db_name: XE
    db_password: owncloud
    db_type: oci
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ -z "true" ]; then make test-php-unit; fi
  - if [ "true" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: true

- name: codecov
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    paths:
    - tests/output
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: oci
  pull: if-not-exists
  image: deepdiver/docker-oracle-xe-11g
  environment:
    ORACLE_DB: XE
    ORACLE_PASSWORD: oracle
    ORACLE_USER: system

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

---
kind: pipeline
name: matrix-8

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.0
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.0
  commands:
  - if [ -z "${COVERAGE}" ]; then make test-php-unit; fi
  - if [ "${COVERAGE}" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: ${COVERAGE}

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.0
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

---
kind: pipeline
name: matrix-9

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiGuests
    MAILHOG_HOST: email
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-10

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiGuests
    MAILHOG_HOST: email
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-11

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: pgsql
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiGuests
    MAILHOG_HOST: email
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: pgsql
  pull: if-not-exists
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-12

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: oci
    db_name: XE
    db_password: owncloud
    db_type: oci
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiGuests
    MAILHOG_HOST: email
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: oci
  pull: if-not-exists
  image: deepdiver/docker-oracle-xe-11g
  environment:
    ORACLE_DB: XE
    ORACLE_PASSWORD: oracle
    ORACLE_USER: system

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-13

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: install-user-management-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/user_management.git /var/www/owncloud/apps/user_management
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e user_management
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIGuests
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-14

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: install-user-management-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - git clone https://github.com/owncloud/user_management.git /var/www/owncloud/apps/user_management
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e user_management
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIGuests
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-15

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: pgsql
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: install-user-management-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - git clone https://github.com/owncloud/user_management.git /var/www/owncloud/apps/user_management
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e user_management
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIGuests
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: pgsql
  pull: if-not-exists
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-16

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: oci
    db_name: XE
    db_password: owncloud
    db_type: oci
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: install-user-management-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - git clone https://github.com/owncloud/user_management.git /var/www/owncloud/apps/user_management
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e user_management
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIGuests
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: oci
  pull: if-not-exists
  image: deepdiver/docker-oracle-xe-11g
  environment:
    ORACLE_DB: XE
    ORACLE_PASSWORD: oracle
    ORACLE_USER: system

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen

- name: email
  pull: always
  image: mailhog/mailhog

---
kind: pipeline
name: matrix-17

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/guests

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ a:e guests
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2

- name: prepare-objectstore
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/apps
  - git clone https://github.com/owncloud/files_primary_s3.git
  - cd files_primary_s3
  - composer install
  - cp tests/drone/scality.config.php /var/www/owncloud/config
  - cd /var/www/owncloud
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:l
  - php occ s3:create-bucket owncloud --accept-warning

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "${USE_RELEASE_TARBALL}" = "true" ]; then cd /var/www/owncloud/testrunner/apps/guests; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiGuests
    MAILHOG_HOST: email
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: email
  pull: always
  image: mailhog/mailhog

- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

...
